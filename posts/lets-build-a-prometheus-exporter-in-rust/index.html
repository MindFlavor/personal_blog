<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Let's build a Prometheus exporter in Rust | MindFlavor's blog</title>
<meta name=keywords content="rust,prometheus,exporter">
<meta name=description content="A step-by-step tutorial on how to create a functioning Prometheus exporter in Rust">
<meta name=author content="Francesco Cogno">
<link rel=canonical href=https://blog.mindflavor.it/posts/lets-build-a-prometheus-exporter-in-rust/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.5407bd846a49e69b70faba3c8dd68a6edea5c86020ca52d35fea8b52b57d81c3.css integrity="sha256-VAe9hGpJ5ptw+ro8jdaKbt6lyGAgylLTX+qLUrV9gcM=" rel="preload stylesheet" as=style>
<link rel=preload href=../../images/mind.jpg as=image>
<link rel=icon href=https://blog.mindflavor.it/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://blog.mindflavor.it/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://blog.mindflavor.it/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://blog.mindflavor.it/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://blog.mindflavor.it/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Let's build a Prometheus exporter in Rust">
<meta property="og:description" content="A step-by-step tutorial on how to create a functioning Prometheus exporter in Rust">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.mindflavor.it/posts/lets-build-a-prometheus-exporter-in-rust/">
<meta property="og:image" content="https://blog.mindflavor.it/images/lets-build-a-prometheus-exporter-in-rust/cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-06-19T00:00:00+00:00">
<meta property="article:modified_time" content="2019-06-19T00:00:00+00:00"><meta property="og:site_name" content="MindFlavor's blog">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.mindflavor.it/images/lets-build-a-prometheus-exporter-in-rust/cover.png">
<meta name=twitter:title content="Let's build a Prometheus exporter in Rust">
<meta name=twitter:description content="A step-by-step tutorial on how to create a functioning Prometheus exporter in Rust">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://blog.mindflavor.it/posts/"},{"@type":"ListItem","position":3,"name":"Let's build a Prometheus exporter in Rust","item":"https://blog.mindflavor.it/posts/lets-build-a-prometheus-exporter-in-rust/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Let's build a Prometheus exporter in Rust","name":"Let\u0027s build a Prometheus exporter in Rust","description":"A step-by-step tutorial on how to create a functioning Prometheus exporter in Rust","keywords":["rust","prometheus","exporter"],"articleBody":"Intro In this post we will build a very simple Prometheus exporter in Rust. Prometheus is a time-series database especially useful in storing and retrieving OS vital signs. It can be paired with Grafana in order to create beautiful dashboards, like this one below:\nPrometheus is peculiar because instead of receiving the events to store it goes on and retrieves them itself. There is no magic though: Prometheus just calls a preconfigured URI and expects a very specific plain text output. This is very elegant because this architecture decouples the service being monitored and the monitor adding an exporter service in between. It’s the exporter’s job to convert the service-specific metrics in a format Prometheus can understand and store.\nThere are tons of pre-made exporters allowing you to monitor the server CPU, the DHCP, etc… with ease. But since this is dev post we won’t stop at combining tools written by others. Instead, we will build an exporter of our own. This will be a very simple exporter but I wanted to show you how easy it is to do it so hopefully you can implement an exporter on your own.\nThe goal We want to keep an eye on the size of a folder. Prometheus can store the folder size every 60 seconds and Grafana can plot the size over time beautifully. It also allows us to create alerts: we can, for example, be notified via Telegram if the folder grows beyond a threshold. But how we create the website needed by Prometheus in order to store the folder size? Enter Rust and an helper crate: Prometheus exporter base. Also, as a bonus, being Rust we will be sure the memory/CPU footprint will be low.\nPrometheus exporter base This crate is open source and MIT licensed (so you can use it freely) and it’s designed to help you create a Prometheus exporter. It will handle most of the boilerplate required by Prometheus (such as rejecting anything but GET verbs and only answering to the /metrics URL). It also provides methods to format the output properly. So first thing first we need to import it by adding the relevant entry to the [Dependencies] section of out Cargo.toml file. This post is written using the version 0.3.0 of the crate so if you end up using a newer version you might have to account for breaking changes (if any).\nThe documentation is very terse: https://docs.rs/prometheus_exporter_base/0.3.0/prometheus_exporter_base/ but don’t fret: all we have to do is to call the render_prometheus method.\nIts signature is this one:\nWhat a mouthful! Basically we need to pass a closure that will be called at every GET request. The closure should return a String or and error. Yes, Rust type system can get carried away. Let’s break down the methods one by one.\nBind address 1  addr: \u0026SocketAddr,  This is the address our exporter will be listening to. We can pass 0.0.0.0 with a port of our choosing. For example this code will do:\n1  letaddr=([0,0,0,0],32221).into();  Options 1 2 3  options: OwhereO: Debug+Clone+Send+Sync+'static  The options can be anything and it will be passed back to our closure at every call. The O type must also be cloneable, debuggable (meaning it must be printable in debug mode) and also must be sendable between threads. It also has to last forever (the 'static lifetime). We do not need options so we create an empty type just for that. Notice how the derive trick makes it trivial:\n1 2  #[derive(Debug, Clone)]struct MyOptions{}  Closure 1 2 3  perform_request: PwhereP: FnOnce(RequestBody,\u0026ArcO)- BoxdynFutureItem=String,Error=Error+Send+'static+Send+Clone+'static,  This is a bit more complicated. What it means we must pass a function that takes the http Request as parameter. The second paramerer is the aforementioned custom option struct O, wrapped in an Arc (Arc allows multiple references of the underlying struct to be owned at the same time). The function must returns a Future: it must either resolve into a String - in case of success - or a failure::Error - in case something goes south. The bunch of other traits are generally less important besides the 'static lifetime. The 'static lifetime here warrants a mention: what it does is to restrict anything captured by the closure to live forever. In practice this just means that we either do not capture anything (easier) or make sure to move ownership into the closure.\nOur exporter Armed with this knowledge we can start creating a stub. Let’s put this code as the main function of our exporter:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  fn main(){letaddr=([0,0,0,0],32221).into();println!(\"starting exporter on {}\",addr);render_prometheus(\u0026addr,MyOptions{},|request,options|{Box::new({println!(\"in our render_prometheus(request == {:?}, options == {:?})\",request,options);ok(\"it's working!\\n\".to_owned())})});}  It will compile and you will get a working webserver listening on port 32221 that:\n Will only allow GET verbs. Will only answer to the path /metrics as per Prometheus specification. Will run our code once invoked. Right now, it will just print something in the exporter’s console window and return a fixed string to the caller.  Let’s try it! After issuing cargo run in our crate we should be able to issue - in another terminal - curl http://localhost:32221/metrics -v. Since it’s a standard HTTP GET you can use a browser to check it just the same.\nNot bad for just few lines of crappy code!\nFolder size calculation Our stub right now doesn’t do anything useful. We want it to be able to calculate the size of a folder. Let’s write a function for that:\n1 2 3 4 5 6 7 8 9 10 11  fn calculate_file_size(path: \u0026str)- Resultu64,std::io::Error{letmuttotal_size: u64 =0;forentryinread_dir(path)?{letp=entry?.path();ifp.is_file(){total_size+=p.metadata()?.len();}}Ok(total_size)}  This function does not calculate the subfolders size but for our purposes will do just fine. Let’s call it from our code. Start by adding this line to our main function:\n1  letfuture_log=done(calculate_file_size(\"/var/log\")).from_err();  Note here the done(...) - from_err() dance that is common with future combinators. Now we replace the ok(\"it's working\\n\".to_owned()) line with the future execution we just created:\n1 2 3  future_log.and_then(|total_size_log|{ok(format!(\"{}\\n\",total_size_log))})  This is easy! Now if we run the exporter again we should receive the proper answer instead of a static string! Nice! Firefox screenshot below:\nJust for reference, now our code is like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  #[derive(Debug, Clone)]struct MyOptions{}fn calculate_file_size(path: \u0026str)- Resultu64,std::io::Error{letmuttotal_size: u64 =0;forentryinread_dir(path)?{letp=entry?.path();ifp.is_file(){total_size+=p.metadata()?.len();}}Ok(total_size)}fn main(){letaddr=([0,0,0,0],32221).into();println!(\"starting exporter on {}\",addr);render_prometheus(\u0026addr,MyOptions{},|request,options|{Box::new({println!(\"in our render_prometheus(request == {:?}, options == {:?})\",request,options);letfuture_log=done(calculate_file_size(\"/var/log\")).from_err();future_log.and_then(|total_size_log|{ok(format!(\"{}\\n\",total_size_log))})})});}  Prometheus compliance This is all well and good but it does not mean our output is Prometheus compliant. In order to do so we should follow a specific format. Luckily the above helper crate has some methods to help us in this endeavor too. We just need to create an instance of PrometheusCounter. The new(...) constructor requires:\n A counter name. This is up to you to get correctly and I refer you the official Prometheus documentation for it. I will just use folder_size for this post. A counter type. Again, please refer to the Prometheus documentation for this. I will go with counter on this one. A counter help text. This is entirely optional but might help other people to understand what your counter is meant to do.  Once created we call the render_header() method so the crate will output the required header for our counter. The code will be like this:\n1 2  letpc=PrometheusCounter::new(\"folder_size\",\"counter\",\"Size of the folder\");letmuts=pc.render_header();  That settles the header. All we need to do now is to output the values. Each counter can optionally have one or more attributes. For example our folder size counter can have the path attribute: this way you could have more than one instance of the same counter in a single response, each indicating a different resource. Our crate allows you to specify the attributes as slice of tuples: attribute-value. For our example we can use a vector like this:\n1 2  letmutattributes=Vec::new();attributes.push((\"path\",\"/var/log/\"));  Now we can call the render_counter function passing the attributes and the value. Like this:\n1  pc.render_counter(Some(\u0026attributes),total_size_log);  All we need to do is to append the rendered counter to the header we just obtained and we are done. Since we already have s that is a mutable String we can append (push) the correctly formatted String there:\n1  s.push_str(\u0026pc.render_counter(Some(\u0026attributes),total_size_log));  Result The final code is like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  usefutures::future::{done,ok,Future};useprometheus_exporter_base::{render_prometheus,PrometheusCounter};usestd::fs::read_dir;#[derive(Debug, Clone)]struct MyOptions{}fn calculate_file_size(path: \u0026str)- Resultu64,std::io::Error{letmuttotal_size: u64 =0;forentryinread_dir(path)?{letp=entry?.path();ifp.is_file(){total_size+=p.metadata()?.len();}}Ok(total_size)}fn main(){letaddr=([0,0,0,0],32221).into();println!(\"starting exporter on {}\",addr);render_prometheus(\u0026addr,MyOptions{},|request,options|{Box::new({println!(\"in our render_prometheus(request == {:?}, options == {:?})\",request,options);letfuture_log=done(calculate_file_size(\"/var/log\")).from_err();future_log.and_then(|total_size_log|{letpc=PrometheusCounter::new(\"folder_size\",\"counter\",\"Size of the folder\");letmuts=pc.render_header();letmutattributes=Vec::new();attributes.push((\"path\",\"/var/log/\"));s.push_str(\u0026pc.render_counter(Some(\u0026attributes),total_size_log));ok(s)})})});}  And the result is like this one:\nConclusion Once added to Prometheus we can create beautiful dashboards like this one:\nPS: I have built a couple of exporters myself, so if you want to see a more real world examples please refer to my GitHub profile!\n Happy Coding,\nFrancesco\n","wordCount":"1501","inLanguage":"en","image":"https://blog.mindflavor.it/images/lets-build-a-prometheus-exporter-in-rust/cover.png","datePublished":"2019-06-19T00:00:00Z","dateModified":"2019-06-19T00:00:00Z","author":[{"@type":"Person","name":"Francesco Cogno"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.mindflavor.it/posts/lets-build-a-prometheus-exporter-in-rust/"},"publisher":{"@type":"Organization","name":"MindFlavor's blog","logo":{"@type":"ImageObject","url":"https://blog.mindflavor.it/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://blog.mindflavor.it accesskey=h title="Home (Alt + H)">
<img src=../../images/mind.jpg alt=logo aria-label=logo height=35>Home</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://blog.mindflavor.it/tags/ title=tags>
<span>tags</span>
</a>
</li>
<li>
<a href=https://blog.mindflavor.it/search/ title="search (Alt + /)" accesskey=/>
<span>search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://blog.mindflavor.it>Home</a>&nbsp;»&nbsp;<a href=https://blog.mindflavor.it/posts/>Posts</a></div>
<h1 class=post-title>
Let's build a Prometheus exporter in Rust
</h1>
<div class=post-description>
A step-by-step tutorial on how to create a functioning Prometheus exporter in Rust
</div>
<div class=post-meta>19 June 2019&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Francesco Cogno&nbsp;|&nbsp;<a href=https://github.com/mindflavor/personal_blog/blob/main/content/posts/lets-build-a-prometheus-exporter-in-rust.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
&nbsp;|&nbsp; <a href=#comments>Comments</a>
</div>
</header>
<figure class=entry-cover><img loading=lazy src=https://blog.mindflavor.it/images/lets-build-a-prometheus-exporter-in-rust/cover.png alt>
</figure>
<div class=disclaimer><b>Disclaimer</b>: This site should not require JavaScript (comments are provided by <a href=https://utteranc.es/>Utterances</a> so if you disable JS they won't show directly here but you can still find them in the <a href=https://github.com/MindFlavor/personal_blog>GitHub repo</a>). It's basically static anyway. Also, I do not care about Google Analytics and "friends". I should not collect anything about you. If you suspect this site does it anyway it means I have misconfigured Hugo: please open an issue to make me wiser. Lastly, I do not host this site directly: what GitHub pages does with your IP is beyond my control. Also, opinions are my own. Not my employer's nor my wife's.
<br>Ah, if you want to, say thank you by donating to the Wikimedia foundation. They are heroes of the free internet.</div>
<br>
<div class=post-content><h2 id=intro>Intro<a hidden class=anchor aria-hidden=true href=#intro>#</a></h2>
<p>In this post we will build a very simple Prometheus exporter in Rust. <a href=https://prometheus.io/>Prometheus</a> is a time-series database especially useful in storing and retrieving OS vital signs. It can be paired with <a href=https://grafana.com/>Grafana</a> in order to create beautiful dashboards, like this one below:</p>
<p><img loading=lazy src=/images/lets-build-a-prometheus-exporter-in-rust/00.png alt>
</p>
<p>Prometheus is peculiar because instead of <em>receiving</em> the events to store it goes on and retrieves them itself. There is no magic though: Prometheus just calls a preconfigured URI and expects a very specific plain text output. This is very elegant because this architecture decouples the service being monitored and the monitor adding an <em>exporter</em> service in between. It&rsquo;s the exporter&rsquo;s job to convert the service-specific metrics in a format Prometheus can understand and store.</p>
<p>There are tons of pre-made exporters allowing you to monitor the server CPU, the DHCP, etc&mldr; with ease. But since this is dev post we won&rsquo;t stop at <em>combining</em> tools written by others. Instead, we will build an exporter of our own. This will be a very simple exporter but I wanted to show you how easy it is to do it so hopefully you can implement an exporter on your own.</p>
<h2 id=the-goal>The goal<a hidden class=anchor aria-hidden=true href=#the-goal>#</a></h2>
<p>We want to keep an eye on the size of a folder. Prometheus can store the folder size every 60 seconds and Grafana can plot the size over time beautifully. It also allows us to create alerts: we can, for example, be notified via Telegram if the folder grows beyond a threshold.
But how we create the website needed by Prometheus in order to store the folder size? Enter Rust and an helper crate: <a href=https://github.com/MindFlavor/prometheus_exporter_base>Prometheus exporter base</a>. Also, as a bonus, being Rust we will be sure the memory/CPU footprint will be low.</p>
<h3 id=prometheus-exporter-base>Prometheus exporter base<a hidden class=anchor aria-hidden=true href=#prometheus-exporter-base>#</a></h3>
<p>This crate is open source and MIT licensed (so you can use it freely) and it&rsquo;s designed to help you create a Prometheus exporter. It will handle most of the boilerplate required by Prometheus (such as rejecting anything but <code>GET</code> verbs and only answering to the <code>/metrics</code> URL). It also provides methods to format the output properly. So first thing first we need to import it by adding the relevant entry to the <code>[Dependencies]</code> section of out <code>Cargo.toml</code> file. This post is written using the version <code>0.3.0</code> of the crate so if you end up using a newer version you might have to account for breaking changes (if any).</p>
<p>The documentation is very terse: <a href=https://docs.rs/prometheus_exporter_base/0.3.0/prometheus_exporter_base/>https://docs.rs/prometheus_exporter_base/0.3.0/prometheus_exporter_base/</a> but don&rsquo;t fret: all we have to do is to call the <a href=https://docs.rs/prometheus_exporter_base/0.3.0/prometheus_exporter_base/fn.render_prometheus.html><code>render_prometheus</code></a> method.</p>
<p>Its signature is this one:</p>
<p><img loading=lazy src=/images/lets-build-a-prometheus-exporter-in-rust/01.png alt>
</p>
<p>What a mouthful! Basically we need to pass a closure that will be called at every GET request. The closure should return a String or and error.
Yes, Rust type system can get carried away. Let&rsquo;s break down the methods one by one.</p>
<h4 id=bind-address>Bind address<a hidden class=anchor aria-hidden=true href=#bind-address>#</a></h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=n>addr</span>: <span class=kp>&amp;</span><span class=nc>SocketAddr</span><span class=p>,</span><span class=w> 
</span></code></pre></td></tr></table>
</div>
</div><p>This is the address our exporter will be listening to. We can pass 0.0.0.0 with a port of our choosing. For example this code will do:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=kd>let</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>([</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=mi>32221</span><span class=p>).</span><span class=n>into</span><span class=p>();</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><h4 id=options>Options<a hidden class=anchor aria-hidden=true href=#options>#</a></h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=n>options</span>: <span class=nc>O</span><span class=w>
</span><span class=w></span><span class=k>where</span><span class=w>
</span><span class=w>    </span><span class=n>O</span>: <span class=nc>Debug</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>The <code>options</code> can be anything and it will be passed back to our closure at every call. The <code>O</code> type must also be cloneable, debuggable (meaning it must be printable in debug mode) and also must be sendable between threads. It also has to last forever (the <code>'static</code> lifetime). We do not need options so we create an empty type just for that. Notice how the <code>derive</code> trick makes it trivial:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#[derive(Debug, Clone)]</span><span class=w>
</span><span class=w></span><span class=k>struct</span> <span class=nc>MyOptions</span><span class=w> </span><span class=p>{}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><h4 id=closure>Closure<a hidden class=anchor aria-hidden=true href=#closure>#</a></h4>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=n>perform_request</span>: <span class=nc>P</span><span class=w>
</span><span class=w></span><span class=k>where</span><span class=w>
</span><span class=w>    </span><span class=n>P</span>: <span class=nb>FnOnce</span><span class=p>(</span><span class=n>Request</span><span class=o>&lt;</span><span class=n>Body</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>Arc</span><span class=o>&lt;</span><span class=n>O</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Box</span><span class=o>&lt;</span><span class=n>dyn</span><span class=w> </span><span class=n>Future</span><span class=o>&lt;</span><span class=n>Item</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w> 
</span></code></pre></td></tr></table>
</div>
</div><p>This is a bit more complicated. What it means we must pass a function that takes the <code>http Request</code> as parameter. The second paramerer is the aforementioned custom option struct <code>O</code>, wrapped in an <code>Arc</code> (<code>Arc</code> allows multiple references of the underlying struct to be owned at the same time). The function must returns a <code>Future</code>: it must either resolve into a <code>String</code> - in case of success - or a <code>failure::Error</code> - in case something goes south. The bunch of other traits are generally less important besides the <code>'static</code> lifetime. The <code>'static</code> lifetime here warrants a mention: what it does is to restrict anything <em>captured</em> by the closure to live forever. In practice this just means that we either do not capture anything (easier) or make sure to move ownership into the closure.</p>
<h3 id=our-exporter>Our exporter<a hidden class=anchor aria-hidden=true href=#our-exporter>#</a></h3>
<p>Armed with this knowledge we can start creating a stub. Let&rsquo;s put this code as the <code>main</code> function of our exporter:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>([</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=mi>32221</span><span class=p>).</span><span class=n>into</span><span class=p>();</span><span class=w>
</span><span class=w>    </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;starting exporter on {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>render_prometheus</span><span class=p>(</span><span class=o>&amp;</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>MyOptions</span><span class=w> </span><span class=p>{},</span><span class=w> </span><span class=o>|</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=nb>Box</span>::<span class=n>new</span><span class=p>({</span><span class=w>
</span><span class=w>            </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=w>
</span><span class=w>                </span><span class=s>&#34;in our render_prometheus(request == {:?}, options == {:?})&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>                </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=w>
</span><span class=w>            </span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>            </span><span class=n>ok</span><span class=p>(</span><span class=s>&#34;it&#39;s working!\n&#34;</span><span class=p>.</span><span class=n>to_owned</span><span class=p>())</span><span class=w>
</span><span class=w>        </span><span class=p>})</span><span class=w>
</span><span class=w>    </span><span class=p>});</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>It will compile and you will get a working webserver listening on port 32221 that:</p>
<ol>
<li>Will only allow GET verbs.</li>
<li>Will only answer to the path <code>/metrics</code> as per Prometheus specification.</li>
<li>Will run our code once invoked. Right now, it will just print something in the exporter&rsquo;s console window and return a fixed string to the caller.</li>
</ol>
<p>Let&rsquo;s try it! After issuing <code>cargo run</code> in our crate we should be able to issue - in another terminal - <code>curl http://localhost:32221/metrics -v</code>. Since it&rsquo;s a standard HTTP GET you can use a browser to check it just the same.</p>
<p><img loading=lazy src=/images/lets-build-a-prometheus-exporter-in-rust/02.png alt>
</p>
<p>Not bad for just few lines of crappy code!</p>
<h2 id=folder-size-calculation>Folder size calculation<a hidden class=anchor aria-hidden=true href=#folder-size-calculation>#</a></h2>
<p>Our stub right now doesn&rsquo;t do anything useful. We want it to be able to calculate the size of a folder. Let&rsquo;s write a function for that:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=k>fn</span> <span class=nf>calculate_file_size</span><span class=p>(</span><span class=n>path</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>std</span>::<span class=n>io</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>total_size</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>read_dir</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entry</span><span class=o>?</span><span class=p>.</span><span class=n>path</span><span class=p>();</span><span class=w>
</span><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>is_file</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>total_size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>metadata</span><span class=p>()</span><span class=o>?</span><span class=p>.</span><span class=n>len</span><span class=p>();</span><span class=w>
</span><span class=w>        </span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>total_size</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>This function does not calculate the subfolders size but for our purposes will do just fine. Let&rsquo;s call it from our code. Start by adding this line to our <code>main</code> function:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=kd>let</span><span class=w> </span><span class=n>future_log</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>done</span><span class=p>(</span><span class=n>calculate_file_size</span><span class=p>(</span><span class=s>&#34;/var/log&#34;</span><span class=p>)).</span><span class=n>from_err</span><span class=p>();</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>Note here the <code>done(...)</code> - <code>from_err()</code> dance that is common with future combinators. Now we replace the <code>ok("it's working\n".to_owned())</code> line with the future execution we just created:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=n>future_log</span><span class=p>.</span><span class=n>and_then</span><span class=p>(</span><span class=o>|</span><span class=n>total_size_log</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=n>ok</span><span class=p>(</span><span class=n>format</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;{}\n&#34;</span><span class=p>,</span><span class=w> </span><span class=n>total_size_log</span><span class=p>))</span><span class=w>
</span><span class=w></span><span class=p>})</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>This is easy! Now if we run the exporter again we should receive the proper answer instead of a static string! Nice! Firefox screenshot below:</p>
<p><img loading=lazy src=/images/lets-build-a-prometheus-exporter-in-rust/03.png alt>
</p>
<p>Just for reference, now our code is like this:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=cp>#[derive(Debug, Clone)]</span><span class=w>
</span><span class=w></span><span class=k>struct</span> <span class=nc>MyOptions</span><span class=w> </span><span class=p>{}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>calculate_file_size</span><span class=p>(</span><span class=n>path</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>std</span>::<span class=n>io</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>total_size</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>read_dir</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entry</span><span class=o>?</span><span class=p>.</span><span class=n>path</span><span class=p>();</span><span class=w>
</span><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>is_file</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>total_size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>metadata</span><span class=p>()</span><span class=o>?</span><span class=p>.</span><span class=n>len</span><span class=p>();</span><span class=w>
</span><span class=w>        </span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>total_size</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>([</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=mi>32221</span><span class=p>).</span><span class=n>into</span><span class=p>();</span><span class=w>
</span><span class=w>    </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;starting exporter on {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>render_prometheus</span><span class=p>(</span><span class=o>&amp;</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>MyOptions</span><span class=w> </span><span class=p>{},</span><span class=w> </span><span class=o>|</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=nb>Box</span>::<span class=n>new</span><span class=p>({</span><span class=w>
</span><span class=w>            </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=w>
</span><span class=w>                </span><span class=s>&#34;in our render_prometheus(request == {:?}, options == {:?})&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>                </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=w>
</span><span class=w>            </span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>future_log</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>done</span><span class=p>(</span><span class=n>calculate_file_size</span><span class=p>(</span><span class=s>&#34;/var/log&#34;</span><span class=p>)).</span><span class=n>from_err</span><span class=p>();</span><span class=w>
</span><span class=w>            </span><span class=n>future_log</span><span class=p>.</span><span class=n>and_then</span><span class=p>(</span><span class=o>|</span><span class=n>total_size_log</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>                </span><span class=n>ok</span><span class=p>(</span><span class=n>format</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;{}\n&#34;</span><span class=p>,</span><span class=w> </span><span class=n>total_size_log</span><span class=p>))</span><span class=w>
</span><span class=w>            </span><span class=p>})</span><span class=w>
</span><span class=w>        </span><span class=p>})</span><span class=w>
</span><span class=w>    </span><span class=p>});</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><h2 id=prometheus-compliance>Prometheus compliance<a hidden class=anchor aria-hidden=true href=#prometheus-compliance>#</a></h2>
<p>This is all well and good but it does not mean our output is Prometheus compliant. In order to do so we should follow a specific format. Luckily the above helper crate has some methods to help us in this endeavor too.
We just need to create an instance of <code>PrometheusCounter</code>. The <code>new(...)</code> constructor requires:</p>
<ol>
<li>A counter name. This is up to you to get correctly and I refer you the official Prometheus documentation for it. I will just use <code>folder_size</code> for this post.</li>
<li>A counter type. Again, please refer to the <a href=https://prometheus.io/docs/concepts/metric_types/>Prometheus documentation</a> for this. I will go with <code>counter</code> on this one.</li>
<li>A counter help text. This is entirely optional but might help other people to understand what your counter is meant to do.</li>
</ol>
<p>Once created we call the <code>render_header()</code> method so the crate will output the required header for our counter. The code will be like this:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=kd>let</span><span class=w> </span><span class=n>pc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PrometheusCounter</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;folder_size&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;counter&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Size of the folder&#34;</span><span class=p>);</span><span class=w>
</span><span class=w></span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pc</span><span class=p>.</span><span class=n>render_header</span><span class=p>();</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>That settles the header. All we need to do now is to output the values. Each counter can optionally have one or more attributes. For example our folder size counter can have the <code>path</code> attribute: this way you could have more than one instance of the same counter in a single response, each indicating a different resource. Our crate allows you to specify the attributes as slice of tuples: attribute-value. For our example we can use a vector like this:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>attributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span><span class=w></span><span class=n>attributes</span><span class=p>.</span><span class=n>push</span><span class=p>((</span><span class=s>&#34;path&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/var/log/&#34;</span><span class=p>));</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>Now we can call the <code>render_counter</code> function passing the attributes and the value. Like this:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=n>pc</span><span class=p>.</span><span class=n>render_counter</span><span class=p>(</span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>attributes</span><span class=p>),</span><span class=w> </span><span class=n>total_size_log</span><span class=p>);</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>All we need to do is to append the rendered counter to the header we just obtained and we are done. Since we already have <code>s</code> that is a mutable <code>String</code> we can append (push) the correctly formatted <code>String</code> there:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=n>s</span><span class=p>.</span><span class=n>push_str</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pc</span><span class=p>.</span><span class=n>render_counter</span><span class=p>(</span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>attributes</span><span class=p>),</span><span class=w> </span><span class=n>total_size_log</span><span class=p>));</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><h2 id=result>Result<a hidden class=anchor aria-hidden=true href=#result>#</a></h2>
<p>The final code is like this:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=k>use</span><span class=w> </span><span class=n>futures</span>::<span class=n>future</span>::<span class=p>{</span><span class=n>done</span><span class=p>,</span><span class=w> </span><span class=n>ok</span><span class=p>,</span><span class=w> </span><span class=n>Future</span><span class=p>};</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>prometheus_exporter_base</span>::<span class=p>{</span><span class=n>render_prometheus</span><span class=p>,</span><span class=w> </span><span class=n>PrometheusCounter</span><span class=p>};</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>fs</span>::<span class=n>read_dir</span><span class=p>;</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=cp>#[derive(Debug, Clone)]</span><span class=w>
</span><span class=w></span><span class=k>struct</span> <span class=nc>MyOptions</span><span class=w> </span><span class=p>{}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>calculate_file_size</span><span class=p>(</span><span class=n>path</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u64</span><span class=p>,</span><span class=w> </span><span class=n>std</span>::<span class=n>io</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>total_size</span>: <span class=kt>u64</span> <span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>read_dir</span><span class=p>(</span><span class=n>path</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=kd>let</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entry</span><span class=o>?</span><span class=p>.</span><span class=n>path</span><span class=p>();</span><span class=w>
</span><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>is_file</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	    </span><span class=n>total_size</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>metadata</span><span class=p>()</span><span class=o>?</span><span class=p>.</span><span class=n>len</span><span class=p>();</span><span class=w>
</span><span class=w>	</span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>total_size</span><span class=p>)</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>addr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>([</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=mi>32221</span><span class=p>).</span><span class=n>into</span><span class=p>();</span><span class=w>
</span><span class=w>    </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;starting exporter on {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>addr</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=n>render_prometheus</span><span class=p>(</span><span class=o>&amp;</span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>MyOptions</span><span class=w> </span><span class=p>{},</span><span class=w> </span><span class=o>|</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=nb>Box</span>::<span class=n>new</span><span class=p>({</span><span class=w>
</span><span class=w>	    </span><span class=n>println</span><span class=o>!</span><span class=p>(</span><span class=w>
</span><span class=w>		</span><span class=s>&#34;in our render_prometheus(request == {:?}, options == {:?})&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>		</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=w>
</span><span class=w>	    </span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>	    </span><span class=kd>let</span><span class=w> </span><span class=n>future_log</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>done</span><span class=p>(</span><span class=n>calculate_file_size</span><span class=p>(</span><span class=s>&#34;/var/log&#34;</span><span class=p>)).</span><span class=n>from_err</span><span class=p>();</span><span class=w>
</span><span class=w>	    </span><span class=n>future_log</span><span class=p>.</span><span class=n>and_then</span><span class=p>(</span><span class=o>|</span><span class=n>total_size_log</span><span class=o>|</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>		</span><span class=kd>let</span><span class=w> </span><span class=n>pc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PrometheusCounter</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;folder_size&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;counter&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Size of the folder&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>		</span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pc</span><span class=p>.</span><span class=n>render_header</span><span class=p>();</span><span class=w>
</span><span class=w>
</span><span class=w>		</span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>attributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Vec</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span><span class=w>		</span><span class=n>attributes</span><span class=p>.</span><span class=n>push</span><span class=p>((</span><span class=s>&#34;path&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/var/log/&#34;</span><span class=p>));</span><span class=w>
</span><span class=w>		</span><span class=n>s</span><span class=p>.</span><span class=n>push_str</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pc</span><span class=p>.</span><span class=n>render_counter</span><span class=p>(</span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=n>attributes</span><span class=p>),</span><span class=w> </span><span class=n>total_size_log</span><span class=p>));</span><span class=w>
</span><span class=w>
</span><span class=w>		</span><span class=n>ok</span><span class=p>(</span><span class=n>s</span><span class=p>)</span><span class=w>
</span><span class=w>	    </span><span class=p>})</span><span class=w>
</span><span class=w>	</span><span class=p>})</span><span class=w>
</span><span class=w>    </span><span class=p>});</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>And the result is like this one:</p>
<p><img loading=lazy src=/images/lets-build-a-prometheus-exporter-in-rust/04.png alt>
</p>
<h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2>
<p>Once added to Prometheus we can create beautiful dashboards like this one:</p>
<p><img loading=lazy src=/images/lets-build-a-prometheus-exporter-in-rust/05.png alt>
</p>
<p>PS: I have built a couple of exporters myself, so if you want to see a more real world examples please refer to <a href=https://github.com/mindflavor>my GitHub profile</a>!</p>
<hr>
<p>Happy Coding,</p>
<p><strong>Francesco</strong></p>
</div>
<a href=#comments>Comments</a>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://blog.mindflavor.it/tags/rust/>rust</a></li>
<li><a href=https://blog.mindflavor.it/tags/prometheus/>prometheus</a></li>
<li><a href=https://blog.mindflavor.it/tags/exporter/>exporter</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://blog.mindflavor.it/posts/querying-sql-server-using-rust-via-odbc/>
<span class=title>« Prev Page</span>
<br>
<span>Querying SQLServer using Rust via ODBC</span>
</a>
<a class=next href=https://blog.mindflavor.it/posts/rust-builder-pattern-with-types/>
<span class=title>Next Page »</span>
<br>
<span>Rust builder pattern with types</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Let's build a Prometheus exporter in Rust on twitter" href="https://twitter.com/intent/tweet/?text=Let%27s%20build%20a%20Prometheus%20exporter%20in%20Rust&url=https%3a%2f%2fblog.mindflavor.it%2fposts%2flets-build-a-prometheus-exporter-in-rust%2f&hashtags=rust%2cprometheus%2cexporter"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Let's build a Prometheus exporter in Rust on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.mindflavor.it%2fposts%2flets-build-a-prometheus-exporter-in-rust%2f&title=Let%27s%20build%20a%20Prometheus%20exporter%20in%20Rust&summary=Let%27s%20build%20a%20Prometheus%20exporter%20in%20Rust&source=https%3a%2f%2fblog.mindflavor.it%2fposts%2flets-build-a-prometheus-exporter-in-rust%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Let's build a Prometheus exporter in Rust on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblog.mindflavor.it%2fposts%2flets-build-a-prometheus-exporter-in-rust%2f&title=Let%27s%20build%20a%20Prometheus%20exporter%20in%20Rust"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Let's build a Prometheus exporter in Rust on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.mindflavor.it%2fposts%2flets-build-a-prometheus-exporter-in-rust%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Let's build a Prometheus exporter in Rust on whatsapp" href="https://api.whatsapp.com/send?text=Let%27s%20build%20a%20Prometheus%20exporter%20in%20Rust%20-%20https%3a%2f%2fblog.mindflavor.it%2fposts%2flets-build-a-prometheus-exporter-in-rust%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Let's build a Prometheus exporter in Rust on telegram" href="https://telegram.me/share/url?text=Let%27s%20build%20a%20Prometheus%20exporter%20in%20Rust&url=https%3a%2f%2fblog.mindflavor.it%2fposts%2flets-build-a-prometheus-exporter-in-rust%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
<h2 id=comments>Comments</h2>
<script src=https://utteranc.es/client.js repo=mindflavor/personal_blog issue-term=pathname label=utterances theme=preferred-color-scheme crossorigin=anonymous async></script>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://blog.mindflavor.it>MindFlavor's blog</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>